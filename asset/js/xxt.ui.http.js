'use strict';
var ngMod = angular.module('http.ui.xxt', []);
ngMod.provider('tmsLocation', function() {
    var _baseUrl;

    this.config = function(baseUrl) {
        _baseUrl = baseUrl || location.pathname;
    };

    this.$get = ['$location', function($location) {
        if (!_baseUrl) {
            _baseUrl = location.pathname;
        }
        return {
            s: function() {
                return $location.search();
            },
            j: function(method) {
                var i = 1,
                    l = arguments.length,
                    url = _baseUrl,
                    _this = this,
                    search = [];
                method && method.length && (url += '/' + method);
                for (; i < l; i++) {
                    search.push(arguments[i] + '=' + $location.search()[arguments[i]]);
                };
                search.length && (url += '?' + search.join('&'));
                return url;
            }
        };
    }];
});
ngMod.service('http2', ['$rootScope', '$http', '$timeout', '$q', '$sce', '$compile', function($rootScope, $http, $timeout, $q, $sce, $compile) {
    function createAlert(msg, type, keep) {
        var alertDomEl;
        /* backdrop */
        alertDomEl = angular.element('<div></div>');
        alertDomEl.attr({
            'class': 'tms-notice alert alert-' + (type ? type : 'info'),
            'ng-style': '{\'z-index\':1040}'
        }).html($sce.trustAsHtml(msg));
        if (!keep) {
            alertDomEl[0].addEventListener('click', function() {
                document.body.removeChild(alertDomEl[0]);
            }, true);
        }
        $compile(alertDomEl)($rootScope);
        document.body.appendChild(alertDomEl[0]);

        return alertDomEl[0];
    }

    function removeAlert(alertDomEl) {
        if (alertDomEl) {
            document.body.removeChild(alertDomEl);
        }
    }

    this.get = function(url, options) {
        var _alert, _timer, _defer = $q.defer();
        options = angular.extend({
            'headers': {
                'accept': 'application/json'
            },
            'autoBreak': true,
            'autoNotice': true,
            'showProgress': true,
            'showProgressDelay': 500,
            'showProgressText': '正在获取数据...',
        }, options);
        if (options.showProgress === true) {
            _timer = $timeout(function() {
                _timer = null;
                _alert = createAlert(options.showProgressText, 'info');
            }, options.showProgressDelay);
        }
        $http.get(url, options).success(function(rsp) {
            if (options.showProgress === true) {
                _timer && $timeout.cancel(_timer);
                if (_alert) {
                    removeAlert(_alert);
                    _alert = null;
                }
            }
            if (angular.isString(rsp)) {
                if (options.autoNotice) {
                    createAlert(rsp, 'warning');
                }
                if (options.autoBreak) {
                    return
                } else {
                    _defer.reject(rsp);
                }
            } else if (rsp.err_code != 0) {
                if (options.autoNotice) {
                    var errmsg;
                    if (angular.isString(rsp.err_msg)) {
                        errmsg = rsp.err_msg;
                    } else if (angular.isArray(rsp.err_msg)) {
                        errmsg = rsp.err_msg.join('<br>');
                    } else {
                        errmsg = JSON.stringify(rsp.err_msg);
                    }
                    createAlert(errmsg, 'warning');
                }
                if (options.autoBreak) {
                    return
                } else {
                    _defer.reject(rsp);
                }
            } else {
                _defer.resolve(rsp);
            }
        }).error(function(data, status) {
            if (options.showProgress === true) {
                _timer && $timeout.cancel(_timer);
                if (_alert) {
                    removeAlert(_alert);
                    _alert = null;
                }
            }
            createAlert(data === null ? '网络不可用' : data, 'danger');
        });

        return _defer.promise;
    };
    this.post = function(url, posted, options) {
        var _alert, _timer, _defer = $q.defer();
        options = angular.extend({
            'headers': {
                'accept': 'application/json'
            },
            'autoBreak': true,
            'autoNotice': true,
            'showProgress': true,
            'showProgressDelay': 500,
            'showProgressText': '正在获取数据...',
        }, options);
        if (options.showProgress === true) {
            _timer = $timeout(function() {
                _timer = null;
                _alert = createAlert(options.showProgressText, 'info');
            }, options.showProgressDelay);
        }
        $http.post(url, posted, options).success(function(rsp) {
            if (options.showProgress === true) {
                _timer && $timeout.cancel(_timer);
                if (_alert) {
                    removeAlert(_alert);
                    _alert = null;
                }
            }
            if (angular.isString(rsp)) {
                if (options.autoNotice) {
                    createAlert(rsp, 'warning');
                    _alert = null;
                }
                if (options.autoBreak) {
                    return
                } else {
                    _defer.reject(rsp);
                }
            } else if (rsp.err_code != 0) {
                if (options.autoNotice) {
                    var errmsg;
                    if (angular.isString(rsp.err_msg)) {
                        errmsg = rsp.err_msg;
                    } else if (angular.isArray(rsp.err_msg)) {
                        errmsg = rsp.err_msg.join('<br>');
                    } else {
                        errmsg = JSON.stringify(rsp.err_msg);
                    }
                    createAlert(errmsg, 'warning');
                }
                if (options.autoBreak) {
                    return
                } else {
                    _defer.reject(rsp);
                }
            } else {
                _defer.resolve(rsp);
            }
        }).error(function(data, status) {
            if (options.showProgress === true) {
                _timer && $timeout.cancel(_timer);
                if (_alert) {
                    removeAlert(_alert);
                    _alert = null;
                }
            }
            createAlert(data === null ? '网络不可用' : data, 'danger');
        });

        return _defer.promise;
    };
}]);