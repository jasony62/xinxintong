<?php
require_once '../../db.php';
// 获得正文中的图片
function getBodyPic($body) {
	$pregRule = "/<img[^>]*\/>/";
	// 获取body中所有的图片地址
	preg_match_all($pregRule, $body, $imgs);
	$imgs = $imgs[0];
	foreach ($imgs as &$img) {// $img = string(88) "<img src=/kcfinder/upload/57dc4f6c25eca6c77cef54bc65c0d61b/%E5%9B%BE%E7%89%87/003.jpg />"
		if (strpos($img, 'http') === false) {
			$img = str_replace('src="', 'src="http://developer.189.cn', $img);
		}
	}

	return $imgs;
}
//
$sql = "select id,title,body from xxt_article where body like '%<img src=%'";
$sql .= " and id in (4716,4574,4545,4546,4769,4767,4762,4759,4760,4758,4739,4755,4754,4751,4748,4746,4743,4742,4735,4736,4734,4732,4729,4728,4699,4723,4720,4719,4717,4714,4713,4707,4710,4708,4709,4706,4704,4703,4702,4688,4698,4690,4689,4683,4687,4686,4685,4675,4684,4682,4681,4672,4678,4677,4676,4668,4674,4673,4671,4661,4667,4666,4665,4573,4663,4660,4659,4655,4656,4650,4649,4644,4645,4640,4642,4641,4634,4600,4630,4629,4597,4623,4620,4610,4607,4601,4594,4590,4589,4588,4584,4571,4568,4553,4538,4540,4486,4481,4479,4474,4478,4477,4470,4467,4466,4460,4459,4458,4454,4456,4455,4451,4450,4448,4445,4442,4444,4443,4441,4424,4428,4427,4414,4415,4416,4411,4405,4412,4404,4402,4393,4392,4387,4386,4382,4364,4363,4357,4355,4326,4325,4318,4308,4292,4291,4271,4267,4135,4129,4202,4178,4549,4550,4547,4548,4551,4552,4653,4652,4651,4239,4449,4391,4381,4243,4244,4246,4248,4249,4250,4251,4252,4253,4254,4255,4256,4228,4199,4360,4518,4517,4516,4515,4514,4513,4512,4511,4510,4509,4508,4507,4506,4505,4519,4501,4499,4496,4495,4494,4492,4383,4265,4263,4261,4260,4259,4258,4226,4208,4206,4204,4201,4264)";
$db_result = $mysqli->query($sql);
$objects = array();
while ($obj = $db_result->fetch_object()) {
	$objects[] = $obj;
}
$sum = 0;
$imgs = [];
foreach ($objects as $object) {
	$imgs[$object->id] = getBodyPic($object->body);
	$sum++;
}

foreach ($imgs as $key => $vals) {
	echo "<<<<<<<<<<<<<<<-ID-" . $key . "->>>>>>>>>>>>>>>";
	echo "<br/>";
	foreach ($vals as $img) {
		echo $img;
	}
	echo "<br/>";
}
echo "<br/>";
echo ">>>>>>>>>>" . $sum . ">>>>>>>>>>";
echo "end update " . __FILE__ . PHP_EOL;
