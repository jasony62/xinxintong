<div class="col-md-12">
    <uib-tabset active="tabActive">
        <uib-tab index="1">
            <uib-tab-heading>行动规则</uib-tab-heading>
            <div class='panel panel-default' ng-controller="ctrlActionRule">
                <div class='panel-body'>
                    <div class='row'>
                        <div class='col-md-6'>
                            <div class='panel panel-default'>
                                <div class='panel-heading'>角色</div>
                                <div class='panel-body'>
                                    <div class='form-group'>
                                        <label>指定活动编辑组</label>
                                        <select class='form-control' ng-model="rule.role.editor.group">
                                            <option value=''>不指定</option>
                                            <option ng-repeat="group in app.groupApp.teams" value="{{group.team_id}}">{{group.title}}</option>
                                        </select>
                                        <div class='help-block'>可以见处理所有不是分组内的记录和数据</div>
                                    </div>
                                    <div class='form-group'>
                                        <label>编辑组用户统一昵称</label>
                                        <input type='text' class='form-control' ng-model="rule.role.editor.nickname" placeholder="输入昵称">
                                        <div class='help-block'>编辑组用户的昵称组外用户不可见，显示为编辑组统一昵称</div>
                                    </div>
                                    <div class='form-group'>
                                        <label>可以查看活动看板的用户组</label>
                                        <select class='form-control' ng-model="rule.role.kanban.group">
                                            <option value=''>所有用户</option>
                                            <option ng-repeat="group in app.groups" value="{{group.team_id}}">{{group.title}}</option>
                                        </select>
                                        <div class='help-block'>超级用户不受次限制</div>
                                    </div>
                                    <button class='btn' ng-class="{'btn-success':rulesModified,'btn-default':!rulesModified}" ng-disabled="!rulesModified" ng-click="save()">保存</button>
                                </div>
                            </div>
                            <hr>
                            <div class='panel panel-default'>
                                <div class='panel-heading'>默认表态</div>
                                <div class='panel-body'>
                                    <div class='form-group'>
                                        <label>提交的记录（问题）的默认表态</label>
                                        <select class='form-control' ng-model="rule.record.default.agreed">
                                            <option value=''></option>
                                            <option value='A'>接受</option>
                                            <option value='D'>讨论</option>
                                        </select>
                                        <div class='help-block'>【讨论】状态的记录仅记录的提交人或同组用户或超级用户可见</div>
                                    </div>
                                    <div class='form-group'>
                                        <label>提交协作填写（答案）的默认表态</label>
                                        <select class='form-control' ng-model="rule.cowork.default.agreed">
                                            <option value=''></option>
                                            <option value='A'>接受</option>
                                            <option value='D'>讨论</option>
                                        </select>
                                        <div class='help-block'>【讨论】状态的数据仅数据的提交人或同组用户或超级用户可见</div>
                                    </div>
                                    <div class='form-group'>
                                        <label>提交留言的默认表态</label>
                                        <select class='form-control' ng-model="rule.remark.default.agreed">
                                            <option value=''></option>
                                            <option value='A'>接受</option>
                                            <option value='D'>讨论</option>
                                        </select>
                                        <div class='help-block'>【讨论】状态的留言仅留言的提交人或同组用户或超级用户可见</div>
                                    </div>
                                    <button class='btn' ng-class="{'btn-success':rulesModified,'btn-default':!rulesModified}" ng-disabled="!rulesModified" ng-click="save()">保存</button>
                                </div>
                            </div>
                            <hr>
                            <div class='panel panel-default'>
                                <div class='panel-heading'>协作填写（答案）可表态的成员</div>
                                <div class='panel-body'>
                                    <div class='checkbox'>
                                        <label>
                                            <input type="checkbox" ng-model="rule.cowork.agreed.pre.author">记录（问题）提交者</label>
                                    </div>
                                    <button class='btn' ng-class="{'btn-success':rulesModified,'btn-default':!rulesModified}" ng-disabled="!rulesModified" ng-click="save()">保存</button>
                                </div>
                            </div>
                            <hr>
                            <div class='panel panel-default'>
                                <div class='panel-heading'>标签</div>
                                <div class='panel-body'>
                                    <div class='checkbox'>
                                        <label>
                                            <input type='checkbox' ng-model="rule.tag.public.pre.editor">仅限活动编辑组用户设置标签对所有人可见</label>
                                    </div>
                                    <div class='form-group'>
                                        <label>标签引用次数操作一定数量后，对所有人可见</label>
                                        <input type='text' class='form-control' ng-model="rule.tag.public.pre.assign_num" placeholder='输入需要的数量'>
                                    </div>
                                    <button class='btn' ng-class="{'btn-success':rulesModified,'btn-default':!rulesModified}" ng-disabled="!rulesModified" ng-click="save()">保存</button>
                                </div>
                            </div>
                            <hr>
                            <div class='panel panel-default'>
                                <div class='panel-heading'>组长任务说明</div>
                                <div class='panel-body'>
                                    <div class='form-group'>
                                        <label>组长至少推荐记录（问题）的数量</label>
                                        <input type='text' class='form-control' ng-model="rule.leader.record.agree.end.min" placeholder="输入需要的数量">
                                    </div>
                                    <div class='form-group'>
                                        <label>组长最多推荐记录（问题）的数量</label>
                                        <input type='text' class='form-control' ng-model="rule.leader.record.agree.end.max" placeholder="输入需要的数量">
                                    </div>
                                    <div class='form-group'>
                                        <label>组长推荐记录（问题）</label>
                                        <textarea class='form-control' ng-model="rule.leader.record.agree.end.desc"></textarea>
                                    </div>
                                    <hr>
                                    <div class='form-group'>
                                        <label>每个记录（问题）组长至少推荐协作填写（答案）的数量</label>
                                        <input type='text' class='form-control' ng-model="rule.leader.cowork.agree.end.min" placeholder="输入需要的数量">
                                    </div>
                                    <div class='form-group'>
                                        <label>每个记录（问题）组长最多推荐协作填写（答案）的数量</label>
                                        <input type='text' class='form-control' ng-model="rule.leader.cowork.agree.end.max" placeholder="输入需要的数量">
                                    </div>
                                    <div class='form-group'>
                                        <label>每个记录（问题）组长推荐协作填写（答案）</label>
                                        <textarea class='form-control' ng-model="rule.leader.cowork.agree.end.desc"></textarea>
                                    </div>
                                    <hr>
                                    <div class='form-group'>
                                        <label>每个记录（问题）组长至少推荐留言的数量</label>
                                        <input type='text' class='form-control' ng-model="rule.leader.remark.agree.end.min" placeholder="输入需要的数量">
                                    </div>
                                    <div class='form-group'>
                                        <label>每个记录（问题）组长最多推荐留言的数量</label>
                                        <input type='text' class='form-control' ng-model="rule.leader.remark.agree.end.max" placeholder="输入需要的数量">
                                    </div>
                                    <div class='form-group'>
                                        <label>每个记录（问题）组长推荐留言</label>
                                        <textarea class='form-control' ng-model="rule.leader.remark.agree.end.desc"></textarea>
                                    </div>
                                    <button class='btn' ng-class="{'btn-success':rulesModified,'btn-default':!rulesModified}" ng-disabled="!rulesModified" ng-click="save()">保存</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </uib-tab>
        <uib-tab index="2">
            <uib-tab-heading>积分规则</uib-tab-heading>
            <div ng-controller="ctrlCoinRule">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>说明</th>
                            <th>活动积分</th>
                            <th ng-if="app.mission">项目积分</th>
                            <th>计算方式</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="r in rules">
                            <td ng-bind="r.data.act"></td>
                            <td ng-bind="r.desc"></td>
                            <td>
                                <input type='text' ng-model="r.data.actor_delta" ng-change="changeRules()">
                            </td>
                            <td ng-if="app.mission">
                                <span>{{r.mission.actor_delta||0}}</span>
                            </td>
                            <td>
                                <label class='radio-inline'>
                                    <input type='radio' name='{{r.data.act}}' value='A' ng-model="r.data.actor_overlap" ng-change="changeRules()">累加
                                </label>
                                <label class='radio-inline'>
                                    <input type='radio' name='{{r.data.act}}' value='R' ng-model="r.data.actor_overlap" ng-change="changeRules()">替代
                                </label>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <button class='btn' ng-class="{'btn-success':rulesModified,'btn-default':!rulesModified}" ng-disabled="!rulesModified" ng-click="save()">保存</button>
            </div>
        </uib-tab>
        <uib-tab index="3">
            <uib-tab-heading>积分日志</uib-tab-heading>
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th style='width:48px'>序号</th>
                        <th style='width:120px'>时间</th>
                        <th>用户</th>
                        <th>获得积分原因</th>
                        <th>获得积分</th>
                        <th>获得总积分</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="log in logs">
                        <td>{{$index+1}}</td>
                        <td>{{log.occur_at*1000|date:'yy-MM-dd hh:mm'}}</td>
                        <td>{{log.nickname}}</td>
                        <td>{{log.act}}</td>
                        <td>{{log.delta}}</td>
                        <td>{{log.user_total_coin}}</td>
                    </tr>
                </tbody>
            </table>
            <div class='form-group' ng-if="page.total>page.size">
                <div class='pl-pagination'>
                    <span>总数：{{page.total}}</span>
                    <ul uib-pagination boundary-links="true" total-items="page.total" max-size="7" items-per-page="page.size" rotate="false" ng-model="page.at" previous-text="&lsaquo;" next-text="&rsaquo;" first-text="&laquo;" last-text="&raquo;" ng-change="fetchLogs()"></ul>
                </div>
            </div>
        </uib-tab>
        <uib-tab index="4">
            <uib-tab-heading>记录转发</uib-tab-heading>
            <div class='panel panel-default' ng-controller="ctrlExportRule">
                <div class='panel-body'>
                    <div class='row'>
                        <div class='col-md-6'>
                            <div class='alert alert-info'>设置将填写记录发布到其他活动的映射规则</div>
                        </div>
                    </div>
                    <div class='row'>
                        <div class='col-md-6'>
                            <div class='panel panel-default' ng-repeat="config in configs">
                                <div class='panel-body'>
                                    <div class='form-group'>
                                        <label>目标活动</label>
                                        <div class='pl-input-group'>
                                            <div class='form-control pl-line' ng-bind="config.app.title"></div>
                                            <button class='btn btn-default' ng-click="pickApp(config)">选择</button>
                                        </div>
                                    </div>
                                    <div ng-repeat="schema in targetDataSchemas[config.app.id]">
                                        <div class="form-group">
                                            <label class='form-label col-md-3' ng-bind="::schema.title"></label>
                                            <div ng-switch on="schema.type" class='col-md-9'>
                                                <select class='form-control' ng-model="config.mappings[schema.id].from" ng-options="schema2.id as schema2.title for schema2 in sourceDataSchemas">
                                                    <option value=>不从当前活动记录中获取</option>
                                                </select>
                                                <textarea class='form-control' ng-switch-when="longtext" ng-model="config.mappings[schema.id].value"></textarea>
                                                <div ng-switch-when="shorttext">
                                                    <input type='text' class='form-control' ng-model="config.mappings[schema.id].value">
                                                </div>
                                                <select class='form-control' ng-switch-when="single" ng-model="config.mappings[schema.id].value" ng-options="op.v as op.l for op in schema.ops">
                                                    <option value=></option>
                                                </select>
                                                <ul ng-switch-when="multiple">
                                                    <li class='checkbox' ng-repeat="op in schema.ops">
                                                        <label>
                                                            <input type="checkbox" name="{{schema.id}}" ng-model="config.mappings[schema.id].value[op.v]" /><span>{{op.l}}</span></label>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <button class='btn' ng-class="{'btn-default':configsModified[config.id]===false,'btn-success':configsModified[config.id]!==false}" ng-click="save(config)">保存</button>
                                    <button class='btn btn-default' ng-click="delConfig(config)">删除</button>
                                </div>
                            </div>
                            <button class='btn btn-default' ng-click="addConfig()">添加</button>
                        </div>
                    </div>
                </div>
            </div>
        </uib-tab>
    </uib-tabset>
</div>